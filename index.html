<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×ª×•×¨ ×œ×”× ×©××”</title>
  <style>
    /* âš™ï¸ ×¢×¨×›×ª ×¦×‘×¢×™× ×‘×”×™×¨×” */
    :root{ --bg:#f7f8fc; --panel:#ffffff; --muted:#4b5563; --border:#e5e7eb; --acc:#1d4ed8; --good:#16a34a; --bad:#dc2626; --text:#0b0f19; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Rubik",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1,h2,h3{margin:8px 0 12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,button,select,textarea{font:inherit;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#ffffff;color:var(--text)}
    button{cursor:pointer}
    .primary{background:var(--acc);border-color:var(--acc);color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}

    /* ×§×œ×¤×™× ×œ×¡×™×“×•×¨ ×ª×•×¨ */
    .queue{display:grid;gap:10px}
    .card-patient{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;align-items:center;gap:12px;user-select:none}
    .drag-handle{width:28px;height:28px;border-radius:8px;background:#eef2ff;border:1px solid #dbeafe;display:flex;align-items:center;justify-content:center;font-weight:700;user-select:none;cursor:grab}
    .card-patient .meta{flex:1}
    .card-patient .rank{width:32px;text-align:center;color:#111827}
    .card-patient.dragging{opacity:.6;outline:2px dashed var(--acc)}
    .swap-hint{font-size:12px;color:var(--muted)}
    .ud-buttons{display:flex;gap:6px}

    /* ×˜×‘×œ××•×ª × ×™×ª×•×— ×‘××¡×š ×”×× ×—×” */
    .heat{width:100%; border-collapse:collapse; font-size:14px}
    .heat th,.heat td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:right}
    .bar{height:14px; background:#e5edff; border:1px solid #dbeafe; border-radius:999px; position:relative}
    .bar > i{display:block; height:100%; background:var(--acc); border-radius:999px}
    .legend{display:flex;gap:8px;flex-wrap:wrap}
    .legend .tag{font-size:12px;padding:4px 10px;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px}

    .qr{background:#ffffff;border:1px dashed var(--border);border-radius:12px;padding:10px}
    .answers{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}

    /* ×¡×˜××˜×™× ×’×“×•×œ×™× */
    .stats-col{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .stat{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .stat h4{margin:0 0 4px 0;font-size:18px}
    .stat p{margin:0;color:var(--muted)}
    .mini{font-size:12px;color:var(--muted)}

    /* ×§×•× ×¡× ×¡×•×¡ ×‘×¢××•×“×” */
    .consensus{display:flex;flex-direction:column;gap:8px;margin-top:6px}

    /* ×¡×™×›×•× ×”××©×—×§ */
    .summary{display:grid;gap:14px}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:right}
    .chip{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .chip b{min-width:4ch;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>×ª×•×¨ ×œ×”× ×©××”</h1>
    <div id="app" class="grid"></div>
  </div>

<script type="module">
/* ===================== ×”×’×“×¨×ª Firebase =====================
   1) ×”×™×›× ×¡/×™ ×œ-Firebase Console ×•×¦×¨/×™ ×¤×¨×•×™×§×˜ ×—×“×©
   2) Realtime Database â†’ Create (××¦×‘ ×‘×“×™×§×”)
   3) Project settings â†’ Your apps â†’ Web â†’ ×”×¢×ª×™×§/×™ firebaseConfig
   4) ×”×“×‘×§/×™ ×›××Ÿ ××ª ×”××•×‘×™×™×§×˜ â†“â†“â†“
*/
const firebaseConfig = {
  // TODO: ×œ×”×“×‘×™×§ ×›××Ÿ ××ª ×”××¤×ª×— (firebaseConfig)
  // apiKey: "...",
  // authDomain: "...",
  // databaseURL: "...",
  // projectId: "...",
  // storageBucket: "...",
  // messagingSenderId: "...",
  // appId: "..."
  apiKey: "AIzaSyC386dVbnZWk_3lrBVbAz9Si8OUJBV7BpU",
  authDomain: "tor-leanshama.firebaseapp.com",
  databaseURL: "https://tor-leanshama-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tor-leanshama",
  storageBucket: "tor-leanshama.firebasestorage.app",
  messagingSenderId: "436293475933",
  appId: "1:436293475933:web:31f81a85eec1d81a0b37b4"
};
/* ========================================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, child, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

if (!firebaseConfig || !firebaseConfig.apiKey) {
  document.querySelector('#app').innerHTML = `
    <div class="card">
      <h2>âš ï¸ ×—×¡×¨ firebaseConfig</h2>
      <p>×¤×ª×—/×™ ××ª ×”×§×•×‘×¥ ×•×”×“×‘×§/×™ ××ª ×”××•×‘×™×™×§×˜ <code>firebaseConfig</code> ×œ×¤×™ ×”×”×•×¨××•×ª ×œ××¢×œ×”.</p>
    </div>`;
  throw new Error("No Firebase config provided");
}

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ===================== ×ª×¨×—×™×© ×•×©×œ×‘×™× ===================== */
const SCENARIO = {
  title: "×ª×•×¨ ×œ×”× ×©××”",
  rounds: [
    { key: 0, name: "×©×œ×‘ 1: ×™×“×•×¢ ×¨×§ ×’×™×œ", show:["age"], desc:"×¡×“×¨×• ××ª ×”×ª×•×¨ ×œ×”× ×©××” ×œ×¤×™ ×’×™×œ ×‘×œ×‘×“." },
    { key: 1, name: "×©×œ×‘ 2: × ×•×¡×¤×” ×”×¡×ª×‘×¨×•×ª ×œ×”×™×©×¨×“×•×ª (%)", show:["age","survival"], desc:"×”×¡×“×¨/×™ ××—×“×© ×ª×•×š ×”×ª×—×©×‘×•×ª ×‘×”×¡×ª×‘×¨×•×ª ×œ×”×™×©×¨×“×•×ª ××—×¨×™ ×˜×™×¤×•×œ." },
    { key: 2, name: "×©×œ×‘ 3: × ×•×¡×£ ××§×¦×•×¢ (××—×“ ×”××˜×•×¤×œ×™× ×”×•× ×¨×•×¤×/×”)", show:["age","survival","job"], desc:"×”×¡×“×¨/×™ ××—×“×© ×¢× ××™×“×¢ ×¢×œ ×”××§×¦×•×¢." },
    { key: 3, name: "×©×œ×‘ 4: × ×•×¡×£ ××•×¨×— ×—×™×™×", show:["age","survival","job","lifestyle"], desc:"×”×¡×“×¨/×™ ××—×“×© ×’× ×œ×¤×™ ××•×¨×— ×”×—×™×™×." }
  ],
  patients: [
    { id:"A", label:"××˜×•×¤×œ A", age: 21, survival: 20,  job:"××•×‘×˜×œ",           lifestyle:"××›×•×¨×” ×œ×”×¨×•××™×Ÿ" },
    { id:"B", label:"××˜×•×¤×œ B", age:75, survival:80,   job:"××××Ÿ ×¨×™×¦×”", lifestyle:"×¡×¤×•×¨×˜××™ ×¤×¢×™×œ" },
    { id:"C", label:"××˜×•×¤×œ×ª C", age:80, survival:20, job:"××“×¢× ×™×ª ×‘×¢×œ×ª ×©× ×¢×•×œ××™", lifestyle:"××•×¨×— ×—×™×™× ×™×•×©×‘× ×™" },
    { id:"D", label:"××˜×•×¤×œ D", age:52, survival:50, job:"×¨×•×¤× ×—×“×¨ ××™×•×Ÿ", lifestyle:"××¢×©×Ÿ ×›×‘×“" },
    { id:"E", label:"××˜×•×¤×œ×ª E", age:34, survival:90, job:"××¤×ª×—×ª ×ª×•×›× ×”", lifestyle:"×¤×¢×™×œ" }
  ]
};

/* ===================== ×¢×–×¨ ===================== */
const $ = s => document.querySelector(s);
const appEl = $("#app");
const params = new URLSearchParams(location.search);
const isHost = params.has("host");

function randCode(n=4){
  const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s=""; for(let i=0;i<n;i++) s+=alphabet[Math.floor(Math.random()*alphabet.length)];
  return s;
}
async function roomExists(code){
  const snap = await get(child(ref(db), `rooms/${code}`));
  return snap.exists();
}
function qrURL(url){
  return `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(url)}`;
}
function escapeHtml(s=""){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function escapeAttr(s=""){return s.replace(/"/g,'&quot;')}

/* ===================== ×—×™×©×•×‘×™× ===================== */
function footrule(a,b){ // sum |posA(id)-posB(id)|
  const idxA = Object.fromEntries(a.map((id,i)=>[id,i]));
  let s=0; for (let i=0;i<b.length;i++){ const id=b[i]; if (idxA[id]!=null) s += Math.abs(idxA[id]-i); }
  return s;
}
function fmax(n){ return Math.floor(n*n/2); }
function bar(percent){ return `<div class=bar><i style="width:${Math.max(0,Math.min(100,percent))}%"></i></div>`; }

function collectSubmissions(players, roundIndex){
  const orders = [];
  for (const pid in players||{}){
    const o = players[pid]?.orders?.[roundIndex];
    if (Array.isArray(o) && o.length>0) orders.push(o);
  }
  return orders; // ××¢×¨×›×™× ×©×œ ××–×”×™ ××˜×•×¤×œ×™× ×‘×¡×“×¨ 1..5
}
function collectStage(players, r){ return collectSubmissions(players, r); }
function avgPositions(patients, orders){
  if (!orders || !orders.length) return null;
  const n = patients.length; const ids = patients.map(p=>p.id);
  const sum = Object.fromEntries(ids.map(id=>[id,0]));
  for (const o of orders){ o.forEach((id, i)=>{ if (sum[id]!=null) sum[id]+= (i+1); }); }
  const avg = {}; for (const id of ids){ avg[id] = sum[id]/orders.length; }
  return avg;
}
function consensusOrderFromAvg(patients, avg){
  if (!avg) return null; return [...patients].sort((a,b)=>avg[a.id]-avg[b.id]).map(p=>p.id);
}

/* ===================== ××¡×š ×× ×—×” ===================== */
function hostUI(code){
  const roomRef = ref(db,`rooms/${code}`);
  onValue(roomRef, snap => renderHost(code, snap.val()||{}));
}

function renderHost(code, data){
  const base    = location.origin + location.pathname;
  const joinURL = `${base}?code=${encodeURIComponent(code)}`; // QR ×›×•×œ×œ ×§×•×“ ×—×“×¨
  const totalPlayers = data.players? Object.keys(data.players).length : 0;
  const roundIndex   = data.roundIndex ?? -1;
  const round        = data.scenario?.rounds?.[roundIndex] || null;
  const patients     = data.scenario?.patients || [];
  const subs         = collectSubmissions(data.players, roundIndex);

  // × ×ª×•× ×™ ×©×™××•×© ×‘"×¡×“×¨ ××§×¨××™" ×‘×©×œ×‘ ×–×”
  const randomizedNow = countRandomized(data.players, roundIndex);
  const submitters = subs.length; // ×›××•×ª ×”×¡×“×¨×™× ×©×”×ª×§×‘×œ×•
  const randRate = submitters? Math.round(100*randomizedNow/submitters):0;

  appEl.innerHTML = `
    <div class=card>
      <div class=row style="justify-content:space-between;align-items:flex-start;">
        <div>
          <h2>×—×“×¨ <span class=mono>${code}</span></h2>
          <div class=row>
            <span class=pill><strong>${totalPlayers}</strong> ××©×ª×ª×¤×™×</span>
            <span class=pill>×©×œ×‘: <strong>${roundIndex<0?"×˜×¨× ×”×ª×—×™×œ":`${roundIndex+1}/4`}</strong></span>
            <span class=pill>×§×‘×œ×ª ×ª×©×•×‘×•×ª: <strong>${data.lock?"×¡×’×•×¨":"×¤×ª×•×—"}</strong></span>
          </div>
          ${round?`<p class=muted style="max-width:680px;margin-top:8px;">${escapeHtml(round.desc)}</p>`:""}
          <div class=row style="margin-top:8px;gap:8px;">
            <button class=primary onclick="startHost('${code}')" ${roundIndex!==-1?"disabled":''}>×”×ª×—×œ ×©×œ×‘ 1</button>
            <button onclick="prevStage('${code}')" ${roundIndex<=0?"disabled":''}>âŸµ ×©×œ×‘ ×§×•×“×</button>
            <button onclick="nextStage('${code}')" ${roundIndex>=3?"disabled":''}>×©×œ×‘ ×”×‘× âŸ¶</button>
            <button onclick="toggleLock('${code}')">${data.lock?"×¤×ª×— ×§×‘×œ×ª ×ª×©×•×‘×•×ª":"×¡×’×•×¨ ×§×‘×œ×ª ×ª×©×•×‘×•×ª"}</button>
            <button onclick="resetOrders('${code}')">××¤×¡ ×ª×©×•×‘×•×ª ×©×œ×‘</button>
          </div>
        </div>
        <div class=qr>
          <img alt="QR" src="${qrURL(joinURL)}"/>
          <div class=muted style="margin-top:6px;">×§×™×©×•×¨ ×œ×§×”×œ: <span class=mono>${joinURL}</span></div>
          <button style="margin-top:6px;" onclick="navigator.clipboard.writeText('${joinURL}')">×”×¢×ª×§×ª ×§×™×©×•×¨</button>
        </div>
      </div>
    </div>

    <div class=card>
      <h2>×ª×™××•×¨ ×”××§×¨×”</h2>
      <div class=answers>
        ${patients.map(p=>renderPatientCard(p, data.roundIndex)).join('')}
      </div>
      <p class=muted>×”××™×“×¢ ××¦×˜×‘×¨ ×‘×™×Ÿ ×”×©×œ×‘×™×: 1) ×’×™×œ â†’ 2) +×”×¡×ª×‘×¨×•×ª ×œ×”×™×©×¨×“×•×ª â†’ 3) +××§×¦×•×¢ â†’ 4) +××•×¨×— ×—×™×™×.</p>
    </div>

    ${ roundIndex>=0 ? `
    <div class=card>
      <h2>×ª×•×¦××•×ª ×©×œ×‘ ${roundIndex+1}</h2>
      <div class=legend>
        <span class=tag>×”×•×’×©×• ×¡×“×¨×™× ×‘×©×œ×‘ ×–×”: <b>${submitters}</b></span>
        <span class=tag>×”×©×ª××©×• ×‘"×¡×“×¨ ××§×¨××™" ×‘×©×œ×‘ ×–×”: <b>${randomizedNow}</b> (~${randRate}%)</span>
      </div>
      ${renderConsensus(patients, subs)}
      ${renderHeatmap(patients, subs)}
      ${renderChangesBlock(data.players, roundIndex, patients)}
    </div>` : `
    <div class=card><h2>×”××©×—×§ ×˜×¨× ×”×ª×—×™×œ</h2><p class=muted>×œ×—×¦×• "×”×ª×—×œ ×©×œ×‘ 1", ×œ××—×¨ ××›×Ÿ ×¤×ª×—×• ×§×‘×œ×ª ×ª×©×•×‘×•×ª.</p></div>
    `}

    ${ roundIndex>=1 ? renderGameSummary(data.players, patients, roundIndex) : '' }
  `;
}

function renderPatientCard(p, roundIndex){
  const showAge = roundIndex>=0;
  const showSurv = roundIndex>=1;
  const showJob = roundIndex>=2;
  const showLife = roundIndex>=3;
  return `
  <div class="card-patient">
    <div class="drag-handle">${p.id}</div>
    <div class="meta">
      <div><strong>${escapeHtml(p.label)}</strong></div>
      <div class="muted">
        ${showAge?`×’×™×œ: <b>${p.age}</b>`:"×’×™×œ: â€”"}
        Â· ${showSurv?`×”×¡×ª×‘×¨×•×ª ×”×™×©×¨×“×•×ª: <b>${p.survival}%</b>`:"×”×¡×ª×‘×¨×•×ª: â€”"}
        Â· ${showJob?`××§×¦×•×¢: <b>${escapeHtml(p.job)}</b>`:"××§×¦×•×¢: â€”"}
        Â· ${showLife?`××•×¨×— ×—×™×™×: <b>${escapeHtml(p.lifestyle)}</b>`:"××•×¨×— ×—×™×™×: â€”"}
      </div>
    </div>
  </div>`;
}

function countRandomized(players, roundIndex){
  let c=0; for (const pid in players||{}){ if (players[pid]?.rand?.[roundIndex]) c++; } return c;
}

function renderConsensus(patients, orders){
  const ids = patients.map(p=>p.id);
  const posSum = Object.fromEntries(ids.map(id=>[id,0]));
  const count = orders.length;
  for (const o of orders){ o.forEach((id, idx)=>{ if (posSum[id]!=null) posSum[id]+= (idx+1); }); }
  const avg = Object.fromEntries(ids.map(id=>[id, count? (posSum[id]/count) : 0]));
  const sorted = [...patients].sort((a,b)=> avg[a.id]-avg[b.id]);
  const list = sorted.map((p,i)=>`
    <div class="pill" style="justify-content:space-between;">
      <div><b>${i+1}.</b> ${escapeHtml(p.label)}</div>
      <div class="muted">×’×™×œ: ${p.age} Â· ×¢××“×” ×××•×¦×¢×ª: ${avg[p.id]?avg[p.id].toFixed(2):"â€”"}</div>
    </div>`).join("");
  return `<h3>×ª×•×¨ ×§×•× ×¡× ×¡×•××œ×™</h3><div class="consensus">${list || '<span class=muted>××™×Ÿ ×¢×“×™×™×Ÿ ×ª×©×•×‘×•×ª</span>'}</div>`
}

function renderHeatmap(patients, orders){
  const n = patients.length;
  const counts = Object.fromEntries(patients.map(p=>[p.id, Array(n).fill(0)]));
  for (const o of orders){ o.forEach((id, idx)=>{ if (counts[id]) counts[id][idx]++; }); }
  const total = orders.length || 1;
  let html = `<h3 style="margin-top:14px;">×”×ª×¤×œ×’×•×ª ××™×§×•××™×</h3><table class=heat><thead><tr><th>××˜×•×¤×œ/×ª (×’×™×œ)</th>${Array.from({length:n},(_,i)=>`<th>${i+1}</th>`).join('')}</tr></thead><tbody>`;
  for (const p of patients){
    html += `<tr><td><b>${escapeHtml(p.label)}</b> <span class=muted>(${p.age})</span></td>`;
    const arr = counts[p.id];
    for (let i=0;i<n;i++){
      const c = arr[i]||0; const w = Math.round(100*c/total);
      html += `<td><div class=bar><i style="width:${w}%"></i></div> <span class=muted>${c}</span></td>`
    }
    html += `</tr>`;
  }
  html += `</tbody></table>`;
  return html;
}

function renderChangesBlock(players, roundIndex, patients){
  if (roundIndex<=0) return `<p class=muted style="margin-top:8px;">× ×ª×•× ×™ ×©×™× ×•×™ ×™×•×¦×’×• ×”×—×œ ××©×œ×‘ 2.</p>`;
  // Spearman footrule ×‘×™×Ÿ ×”×©×œ×‘ ×”× ×•×›×—×™ ×œ×§×•×“× ×œ×›×œ ××©×ª×ª×£
  let have=0, sum=0, buckets={"0":0,"1-2":0,"3+":0}, randAmong=0;
  for (const pid in players||{}){
    const prev = players[pid]?.orders?.[roundIndex-1];
    const cur  = players[pid]?.orders?.[roundIndex];
    if (Array.isArray(prev) && Array.isArray(cur)){
      const dist = footrule(prev, cur);
      have++; sum += dist;
      if (players[pid]?.rand?.[roundIndex]) randAmong++;
      if (dist===0) buckets["0"]++; else if (dist<=2) buckets["1-2"]++; else buckets["3+"]++;
    }
  }
  if (!have) return `<p class=muted style="margin-top:8px;">××™×Ÿ ×¢×“×™×™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×œ×”×©×•×•××”.</p>`;
  const avg = (sum/have);
  const n   = patients.length; const mx = fmax(n);
  const pct = Math.round(100*avg/mx);
  const randPct = Math.round(100*randAmong/have);
  return `
    <div style="margin-top:14px">
      <h3>×©×™× ×•×™×™× ×‘×™×Ÿ ×©×œ×‘×™×</h3>
      <div class="stats-col">
        <div class=stat>
          <h4>××“×“ ×©×™× ×•×™ ×××•×¦×¢</h4>
          <div style="font-size:22px;font-weight:700;">${avg.toFixed(2)}</div>
          <div class=mini>${avg.toFixed(2)} / ${mx} (${pct}%)</div>
          ${bar(pct)}
          <p>Spearman footrule â€” ×¡×›×•× ×”×”×¤×¨×©×™× ×”××•×—×œ×˜×™× ×‘××™×§×•× ×œ×›×œ ××˜×•×¤×œ/×ª ×‘×™×Ÿ ×©× ×™ ×©×œ×‘×™×, ×××•×¦×¢ ×¢×œ ×¤× ×™ ×”××©×ª×ª×¤×™×. ××™× ×“×™×§×˜×•×¨ ×× ×¨××œ ××•×œ ×”××§×¡×™××•× ×”××¤×©×¨×™.</p>
        </div>
        <div class=stat>
          <h4>×œ×œ× ×©×™× ×•×™</h4>
          <div style="font-size:22px;font-weight:700;">${buckets["0"]}</div>
          <p>××¡×¤×¨ ××©×ª×ª×¤×™× ×©×œ× ×©×™× ×• ×›×œ×œ ××ª ×”×¡×“×¨ ×‘×™×Ÿ ×©× ×™ ×”×©×œ×‘×™×.</p>
        </div>
        <div class=stat>
          <h4>1â€“2 ×”×—×œ×¤×•×ª</h4>
          <div style="font-size:22px;font-weight:700;">${buckets["1-2"]}</div>
          <p>×©×™× ×•×™ ×§×˜×Ÿ â€” ×¢×“ ×©×ª×™ ×”×—×œ×¤×•×ª ××§×•××•×ª.</p>
        </div>
        <div class=stat>
          <h4>3+ ×”×—×œ×¤×•×ª</h4>
          <div style="font-size:22px;font-weight:700;">${buckets["3+"]}</div>
          <p>×©×™× ×•×™ ××©××¢×•×ª×™ â€” ×©×œ×•×© ×”×—×œ×¤×•×ª ×•××¢×œ×”.</p>
        </div>
        <div class=stat>
          <h4>×”×©×ª××©×• ×‘"×¡×“×¨ ××§×¨××™"</h4>
          <div style="font-size:22px;font-weight:700;">${randAmong} (${randPct}%)</div>
          <p>××ª×•×š ××™ ×©×”×’×™×©×• ×‘×©× ×™ ×”×©×œ×‘×™× ×”× ×•×›×—×™×™× â€” ×›××” ×”×©×ª××©×• ×‘××§×¨××™ ×‘×©×œ×‘ ×”× ×•×›×—×™.</p>
        </div>
      </div>
    </div>`;
}

function renderGameSummary(players, patients, roundIndex){
  // 1) Trajectories: avg position per patient per stage + deltas
  const stages = [0,1,2,3];
  const avgs = {};
  for (const r of stages){ avgs[r] = avgPositions(patients, collectStage(players, r)); }

  let traj = `<h3>××¡×œ×•×œ×™ ××˜×•×¤×œ×™× (××™×§×•× ×××•×¦×¢ ×‘×›×œ ×©×œ×‘)</h3><table class=table><thead><tr><th>××˜×•×¤×œ/×ª</th>${stages.map(i=>`<th>×©×œ×‘ ${i+1}</th>`).join('')}</tr></thead><tbody>`;
  for (const p of patients){
    traj += `<tr><td><b>${escapeHtml(p.label)}</b></td>`;
    let prev = null;
    for (const r of stages){
      const a = avgs[r]?.[p.id];
      if (a){
        let delta = prev!=null ? (prev - a) : null; // ×™×¨×™×“×” = ×¢×œ×™×™×” ×‘×¢×“×™×¤×•×ª
        let arrow = '';
        if (delta!=null){
          const sign = delta>0 ? '+' : (delta<0 ? 'âˆ’' : 'Â±');
          const sym  = delta>0 ? 'â–²' : (delta<0 ? 'â–¼' : 'â€¢');
          arrow = ` <span class=mini>${sym} ${sign}${Math.abs(delta).toFixed(2)}</span>`;
        }
        traj += `<td>${a.toFixed(2)}${arrow}</td>`; prev = a;
      } else {
        traj += `<td class=muted>â€”</td>`;
      }
    }
    traj += `</tr>`;
  }
  traj += `</tbody></table>`;

  // 2) Agreement per stage: avg normalized footrule vs consensus
  let agree = `<h3 style="margin-top:12px">××“×“ ×”×¡×›××” ×œ×¤×™ ×©×œ×‘</h3><div class=summary>`;
  for (const r of stages){
    const orders = collectStage(players, r);
    if (!orders.length){ agree += `<div class=chip><b>×©×œ×‘ ${r+1}</b><span class=muted>××™×Ÿ × ×ª×•× ×™×</span></div>`; continue; }
    const avgMap = avgs[r];
    const cons = consensusOrderFromAvg(patients, avgMap);
    if (!cons){ agree += `<div class=chip><b>×©×œ×‘ ${r+1}</b><span class=muted>××™×Ÿ × ×ª×•× ×™×</span></div>`; continue; }
    const mx = fmax(patients.length);
    let sum=0; for (const o of orders){ sum += footrule(cons, o); }
    const avgF = sum/orders.length; const pct = Math.round(100*(1 - (avgF/mx)));
    agree += `<div class=chip><b>×©×œ×‘ ${r+1}</b><div style="flex:1">${bar(pct)}</div><span class=mono>${pct}%</span></div>`;
  }
  agree += `</div>`;

  return `<div class=card><h2>×¡×™×›×•× ×”××©×—×§</h2>${traj}${agree}</div>`;
}

/* ===================== ××¡×š ××©×ª×ª×£ ===================== */
let playerId   = localStorage.getItem("triage_player_id") || null;
let playerName = localStorage.getItem("triage_player_name") || "";

function playerUI(code){
  const roomRef = ref(db,`rooms/${code}`);
  onValue(roomRef, snap => renderPlayer(code, snap.val()||{}));
}

function renderPlayer(code, data){
  if (!playerId) { playerId = crypto.randomUUID(); localStorage.setItem("triage_player_id", playerId); }
  const joined     = !!(data.players && data.players[playerId]);
  const me         = data.players?.[playerId] || {};
  const roundIndex = data.roundIndex ?? -1;
  const round      = data.scenario?.rounds?.[roundIndex] || null;
  const patients   = data.scenario?.patients || [];
  const lock       = !!data.lock;

  // ×¡×“×¨ × ×•×›×—×™: ××”×ª×©×•×‘×” ×‘×©×œ×‘, ××• ××”×©×œ×‘ ×”×§×•×“×, ××• ×œ×¤×™ ××–×”×™×
  const curOrder = me.orders?.[roundIndex]
    || me.orders?.[roundIndex-1]
    || patients.map(p=>p.id);

  appEl.innerHTML = `
    <div class=card>
      <h2>×—×“×¨ <span class=mono>${code}</span></h2>
      ${!joined ? `
        <div class=row>
          <input id=nm placeholder="×©×" value="${escapeAttr(playerName)}" />
          <button class=primary onclick="join('${code}')">×›× ×™×¡×”</button>
        </div>
      ` : `
        <div class=row>
          <span class=pill>××ª/×”: <b>${escapeHtml(me.name||"××•×¨×—/×ª")}</b></span>
          <button onclick="leave('${code}')">×™×¦×™××”</button>
        </div>
      `}
    </div>

    ${ roundIndex<0 ? `
      <div class=card><h2>×××ª×™× ×™× ×œ×ª×—×™×œ×ª ×”××©×—×§â€¦</h2></div>
    ` : !joined ? `` : `
      <div class=card>
        <h2>${escapeHtml(round.name)}</h2>
        <p class=muted>${escapeHtml(round.desc)}</p>
        <div class=row style="margin:8px 0">
          <button onclick="randomize('${code}')" ${lock?"disabled":''}>ğŸ² ×¡×“×¨ ××§×¨××™</button>
          <button class=primary onclick="submitOrder('${code}')" ${lock?"disabled":''}>×©×œ×—/×™</button>
          <span class=muted>×§×‘×œ×ª ×ª×©×•×‘×•×ª: <b>${lock?"×¡×’×•×¨":"×¤×ª×•×—"}</b></span>
        </div>
        <div class=swap-hint>××¤×©×¨ ×œ×’×¨×•×¨ ×‘×¢×›×‘×¨ ××• ×œ×”×§×™×© ×¢×œ ×©× ×™ ×§×œ×¤×™× ×›×“×™ ×œ×”×—×œ×™×£ ×‘×™× ×™×”×. ×™×© ×’× ×—×™×¦×™× â†‘/â†“ ×œ×”×–×–×” ××“×•×™×§×ª.</div>
        <div id=queue class=queue data-lock="${lock}"></div>
      </div>
    `}
  `;

  if (roundIndex>=0 && joined){ buildQueueUI('#queue', patients, curOrder, roundIndex, lock); }
}

function buildQueueUI(sel, patients, order, roundIndex, lock){
  const el = $(sel); el.innerHTML = '';
  const byId = Object.fromEntries(patients.map(p=>[p.id,p]));
  const ids = order && order.length===patients.length ? order.slice() : patients.map(p=>p.id);
  let tapFirst = null; // ×œ×˜××¥'

  ids.forEach((id, idx)=>{
    const p = byId[id];
    const row = document.createElement('div');
    row.className = 'card-patient';
    row.setAttribute('draggable', String(!lock));
    row.dataset.id = id;

    row.innerHTML = `
      <div class=drag-handle>â‰¡</div>
      <div class=rank mono>${idx+1}</div>
      <div class=meta>
        <div><b>${escapeHtml(p.label)}</b></div>
        <div class=muted>
          ${roundIndex>=0?`×’×™×œ: <b>${p.age}</b>`:"×’×™×œ: â€”"}
          Â· ${roundIndex>=1?`×”×¡×ª×‘×¨×•×ª ×”×™×©×¨×“×•×ª: <b>${p.survival}%</b>`:"×”×¡×ª×‘×¨×•×ª: â€”"}
          Â· ${roundIndex>=2?`××§×¦×•×¢: <b>${escapeHtml(p.job)}</b>`:"××§×¦×•×¢: â€”"}
          Â· ${roundIndex>=3?`××•×¨×— ×—×™×™×: <b>${escapeHtml(p.lifestyle)}</b>`:"××•×¨×— ×—×™×™×: â€”"}
        </div>
      </div>
      <div class=ud-buttons>
        <button ${lock?"disabled":''} title="×œ××¢×œ×”" data-up>â†‘</button>
        <button ${lock?"disabled":''} title="×œ××˜×”" data-down>â†“</button>
      </div>`;

    row.querySelector('[data-up]')?.addEventListener('click',()=>{ if(lock) return; move(id,-1); });
    row.querySelector('[data-down]')?.addEventListener('click',()=>{ if(lock) return; move(id,1); });

    // tap-to-swap
    row.addEventListener('click',(e)=>{
      if (lock) return; if (e.target.closest('button')) return;
      if (!tapFirst){ tapFirst=row; row.style.outline = `2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--acc')}`; }
      else if (tapFirst===row){ tapFirst.style.outline='none'; tapFirst=null; }
      else { const idA=tapFirst.dataset.id, idB=row.dataset.id; tapFirst.style.outline='none'; tapFirst=null; swap(idA,idB); }
    });

    // Drag & drop
    row.addEventListener('dragstart',(e)=>{ if(lock) return; e.dataTransfer && e.dataTransfer.setData('text/plain', id); row.classList.add('dragging'); });
    row.addEventListener('dragend',()=>{ row.classList.remove('dragging'); refreshRanks(); });

    el.appendChild(row);
  });

  el.addEventListener('dragover', (e)=>{
    e.preventDefault(); if (lock) return;
    const dragging = el.querySelector('.dragging'); if (!dragging) return;
    const after = getDragAfterElement(el, e.clientY);
    if (after==null) el.appendChild(dragging); else el.insertBefore(dragging, after);
  });

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.card-patient:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if (offset<0 && offset>closest.offset) return {offset, element: child};
      else return closest;
    }, {offset: Number.NEGATIVE_INFINITY}).element;
  }

  function currentOrder(){ return [...el.querySelectorAll('.card-patient')].map(n=>n.dataset.id); }
  function refreshRanks(){ [...el.querySelectorAll('.card-patient .rank')].forEach((r,i)=> r.textContent = i+1); }
  function swap(idA,idB){
    const a = el.querySelector(`[data-id="${idA}"]`);
    const b = el.querySelector(`[data-id="${idB}"]`);
    if (!a||!b) return;
    const na = a.nextSibling; el.insertBefore(a, b); el.insertBefore(b, na); refreshRanks(); saveLocal(codeKey(), currentOrder());
  }
  function move(id, dir){
    const nodes = [...el.querySelectorAll('.card-patient')];
    const idx = nodes.findIndex(n=>n.dataset.id===id);
    const target = idx+dir; if (target<0||target>=nodes.length) return;
    const node = nodes[idx]; if (dir<0) el.insertBefore(node, nodes[target]); else el.insertBefore(nodes[target].nextSibling, node);
    refreshRanks(); saveLocal(codeKey(), currentOrder());
  }

  // save initial
  saveLocal(codeKey(), currentOrder());
}

function codeKey(){
  const q = new URLSearchParams(location.search);
  const code = q.get('code') || 'host';
  return `triage_order_${code}`;
}
function saveLocal(key, order){ try{ localStorage.setItem(key, JSON.stringify(order)); }catch(e){} }
function loadLocal(key){ try{ return JSON.parse(localStorage.getItem(key)||'null'); }catch(e){return null} }

/* ===================== ×¤×¢×•×œ×•×ª (×× ×—×”/××©×ª×ª×£) ===================== */
window.startHost = async (code)=>{
  const rr = ref(db,`rooms/${code}`);
  const d = (await get(rr)).val(); if (!d || d.roundIndex!==-1) return;
  await update(rr, { roundIndex: 0, lock: false });
};

window.nextStage = async (code)=>{
  const rr = ref(db,`rooms/${code}`);
  const d = (await get(rr)).val(); if (!d) return;
  if ((d.roundIndex??-1) >= 3) return;
  await update(rr, { roundIndex: d.roundIndex+1, lock: false });
};

window.prevStage = async (code)=>{
  const rr = ref(db,`rooms/${code}`);
  const d = (await get(rr)).val(); if (!d) return;
  if ((d.roundIndex??0) <= 0) return;
  await update(rr, { roundIndex: d.roundIndex-1, lock: false });
};

window.toggleLock = async (code)=>{
  const rr = ref(db,`rooms/${code}`);
  const d = (await get(rr)).val(); if (!d) return;
  await update(rr, { lock: !d.lock });
};

window.resetOrders = async (code)=>{
  const rr = ref(db,`rooms/${code}`);
  const d = (await get(rr)).val(); if (!d) return;
  const ri = d.roundIndex; if (ri<0) return;
  const updates = {};
  for (const pid in d.players||{}) updates[`players/${pid}/orders/${ri}`] = null;
  await update(rr, updates);
};

window.join = async (code)=>{
  const name = ($("#nm")?.value || "").trim() || "××•×¨×—/×ª";
  playerName = name; localStorage.setItem("triage_player_name", name);
  const meRef = ref(db,`rooms/${code}/players/${playerId}`);
  await update(meRef, { name });
};

window.leave = async (code)=>{
  const meRef = ref(db,`rooms/${code}/players/${playerId}`);
  await set(meRef, null);
};

window.randomize = async (code)=>{
  // ×¢×¨×‘×•×‘ ×œ×•×§×œ×™ + ×¡×™××•×Ÿ ×‘×“×˜×” ×©×”××©×ª××© ×‘×—×¨ ××§×¨××™ ×‘×©×œ×‘ ×”× ×•×›×—×™
  const rr = ref(db,`rooms/${code}`);
  const d  = (await get(rr)).val(); if (!d) return;
  const ri = d.roundIndex; if (ri<0) return;

  const key = codeKey();
  const el = document.querySelector('#queue'); if (!el) return;
  const arr = [...el.querySelectorAll('.card-patient')].map(n=>n.dataset.id);
  for (let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }

  const map = Object.fromEntries([...el.children].map(n=>[n.dataset.id, n]));
  arr.forEach(id=>{ const node = map[id]; if (node) el.appendChild(node); });
  [...el.querySelectorAll('.card-patient .rank')].forEach((r,i)=> r.textContent = i+1);
  localStorage.setItem(key, JSON.stringify(arr));

  // ×¡×™××•×Ÿ ×‘×“×˜×”: ×”××©×ª××© ×‘×—×¨ "×¡×“×¨ ××§×¨××™" ×‘×©×œ×‘ ×–×”
  const meRef = ref(db,`rooms/${code}/players/${playerId}/rand`);
  const patch  = {}; patch[ri] = true; await update(meRef, patch);
};

window.submitOrder = async (code)=>{
  const el = document.querySelector('#queue'); if (!el) return;
  const order = [...el.querySelectorAll('.card-patient')].map(n=>n.dataset.id);
  const rr = ref(db,`rooms/${code}`);
  const d  = (await get(rr)).val(); if (!d) return;
  if (d.lock) { alert('×§×‘×œ×ª ×ª×©×•×‘×•×ª ×¡×’×•×¨×”'); return; }
  const ri = d.roundIndex; if (ri<0) return;
  const meRef = ref(db,`rooms/${code}/players/${playerId}`);
  const me = (await get(meRef)).val() || {};
  const orders = me.orders || {};
  orders[ri] = order;
  await update(meRef, { orders });
  alert('× ×©×œ×—! × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×•×œ×©×œ×•×— ×©×•×‘ ×¢×“ ×œ×¡×’×™×¨×”.');
};

/* ===================== ×›× ×™×¡×” ×¨××©×™×ª ===================== */
(async function main(){
  if (isHost) {
    const code = await createRoom();
    hostUI(code);
  } else {
    let code = new URLSearchParams(location.search).get('code');
    if (!code) {
      appEl.innerHTML = `
        <div class=card>
          <h2>×›× ×™×¡×” ×œ×—×“×¨</h2>
          <div class=row>
            <input id=code maxlength=6 placeholder="×§×•×“ ×—×“×¨ (×œ××©×œ: ABCD)" />
            <button class=primary onclick="go()">×›× ×™×¡×”</button>
          </div>
          <p class=muted>×‘×§×©/×™ ××”×× ×—×” ××ª ×”×§×•×“ ×©××•×¤×™×¢ ×¢×œ ×”××¡×š.</p>
        </div>`;
      window.go = async ()=>{
        const v = (document.querySelector('#code').value||'').trim().toUpperCase();
        if (!v) return; const exists = await roomExists(v);
        if (!exists) { alert('×—×“×¨ ×œ× × ××¦×'); return; }
        location.search = '?code='+encodeURIComponent(v);
      };
      return;
    }
    code = code.toUpperCase();
    const exists = await roomExists(code);
    if (!exists) { appEl.innerHTML = `<div class=card><h2>×”×—×“×¨ ${code} ×œ× ×§×™×™×</h2></div>`; return; }
    playerUI(code);
  }
})();
</script>
</body>
</html>
